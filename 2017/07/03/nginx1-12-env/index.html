<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="知道自己想要做什么,比怎么做更重要">
    

    <!--Author-->
    
        <meta name="author" content="klion">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="极速部署 nginx 1.12.0"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="知道自己想要做什么,比怎么做更重要" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="klion&#39;s blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>极速部署 nginx 1.12.0 - klion&#39;s blog</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    about me
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    blogs
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2017/07/03/nginx1-12-env/">
                极速部署 nginx 1.12.0
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-07-03</span>
            
            
            
                <span class="category">
                    <a href="/categories/env/">env</a>
                </span>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <p><br><br>00x1 依旧是先简单的科普:<br>&nbsp;&nbsp;&nbsp;&nbsp;nginx [tengine基于Nginx的变种] 一款流行的开源web中间件,基于c,毛子写的,支持高并发[epoll模型,日PV2000W以内基本是没什么感觉的],不过,高并发仅仅是针对静态资源来说的,如果是动态资源还要看后端脚本和数据库的实际处理速度,另外,它本身占用资源较少,配置也十分方便灵活</p>
<p>00x2 除了提供基本的web服务相关功能之外,它也提供了很多其它的很实用的功能[都是基于模块的形式]:<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">动态脚本解析服务</div><div class="line">反向代理[类似负载均衡,f5,a10]</div><div class="line">提供缓存功能,类似ats varnish...</div><div class="line">....</div></pre></td></tr></table></figure></p>
<p>00x3 安装 nginx前的一些必要的准备工作:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> rpm -qa pcre pcre-devel openssl-devel		正则库,nginx中的rwrite模块会用到,后面是加密函数库,https要用到</span></div><div class="line"><span class="meta">#</span><span class="bash"> mount /dev/cdrom /mnt/cdrom/  		因为我这里用的是本地yum源,所以需要先挂下光盘,如果你直接用的网络yum源,可以忽略此步骤</span></div><div class="line"><span class="meta">#</span><span class="bash"> yum install pcre pcre-devel openssl openssl-devel -y		安装所需的所有依赖库</span></div><div class="line"><span class="meta">#</span><span class="bash"> useradd -s /sbin/nologin -M nginx		创建nginx服务用户,既是服务用户,也就意味着它并不需要登陆系统,更不需要有家目录</span></div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>00x4 下载,编译安装,启动nginx:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">export</span>  LANG=en</span></div><div class="line"><span class="meta">#</span><span class="bash"> wget http://nginx.org/download/nginx-1.12.0.tar.gz</span></div><div class="line"><span class="meta">#</span><span class="bash"> tar xf nginx-1.12.0.tar.gz</span></div><div class="line"><span class="meta">#</span><span class="bash"> tree  nginx-1.12.0 | more</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> nginx-1.12.0/src/core/</span></div><div class="line"><span class="meta">#</span><span class="bash"> vi nginx.h	在源码层彻底隐藏nginx版本</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> ../../</span></div><div class="line"><span class="meta">#</span><span class="bash"> ./configure --<span class="built_in">help</span>	查看nginx所支持的所有模块,你可以根据自己的实际需求选择性的安装</span></div><div class="line"><span class="meta">#</span><span class="bash"> ./configure --prefix=/usr/<span class="built_in">local</span>/nginx-1.12.0 --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module --with-http_gzip_static_module</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> $?</span></div><div class="line"><span class="meta">#</span><span class="bash"> make &amp;&amp; make install</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> $?</span></div><div class="line"><span class="meta">#</span><span class="bash"> ln -s /usr/<span class="built_in">local</span>/nginx-1.12.0/ /usr/<span class="built_in">local</span>/nginx</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -v	查看nginx版本</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx 	启动nginx服务</span></div><div class="line"><span class="meta">#</span><span class="bash"> lsof -i :80</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s quit	停止nginx服务</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">kill</span> -QUIT 27615	如果上面实在不行,直接杀掉nginx主进程就好了</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"/usr/local/nginx/sbin/nginx"</span> &gt;&gt; /etc/rc.local</span></div></pre></td></tr></table></figure></p>
<p>00x5 记得每次在修改完nginx配置文件以后,务必要重启nginx服务才能使配置生效<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t		检查配置文件语法是否正确</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload		确认配置文件没有任何问题以后执行nginx重载操作</span></div></pre></td></tr></table></figure></p>
<p>00x6 nginx 常用模块,更多模块详情请直接参考其官方说明:<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">核心模块</div><div class="line">http模块</div><div class="line">....</div></pre></td></tr></table></figure></p>
<p>00x7 nginx 目录结构:<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># tree  /usr/local/nginx</span></div><div class="line">|<span class="string">-- client_body_temp</span></div><div class="line">|<span class="string">-- conf</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- fastcgi.conf	动态脚本解析配置文件</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- fastcgi.conf.default</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- fastcgi_params</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- fastcgi_params.default</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- koi-utf</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- koi-win</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- mime.types</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- mime.types.default</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- nginx.confnginx		主配置文件</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- nginx.conf.default</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- scgi_params</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- scgi_params.default</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- uwsgi_params</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- uwsgi_params.default</span></div><div class="line">|<span class="string">   `-- win-utf</span></div><div class="line">|<span class="string">-- fastcgi_temp</span></div><div class="line">|<span class="string">-- html	网站根目录</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- 50x.html</span></div><div class="line">|<span class="string">   `-- index.html</span></div><div class="line">|<span class="string">-- logs	日志文件目录</span></div><div class="line">|<span class="string">   </span>|<span class="string">-- access.log</span></div><div class="line">|<span class="string">   `-- error.log</span></div><div class="line">|<span class="string">-- proxy_temp</span></div><div class="line">|<span class="string">-- sbin</span></div><div class="line">|<span class="string">   `-- nginx	nginx主程序</span></div><div class="line">|<span class="string">-- scgi_temp</span></div><div class="line">`-- uwsgi_temp</div></pre></td></tr></table></figure></p>
<p>00x8 nginx 主配置文件主要参数说明,注意,所有参数均以’分号’表示结束:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/nginx/conf/</span></div><div class="line"><span class="meta">#</span><span class="bash"> egrep -v <span class="string">"#|^$"</span>  nginx.conf.default &gt; nginx.conf</span></div></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># main 核心区</span></div><div class="line">	worker_processes  1;		一般和cpu的核数相等	</div><div class="line">	error_log  logs/error.log;	错误日志位置		</div><div class="line">	pid        logs/nginx.pid;	nginx进程id号,必要的时候可以直接杀进程id	</div><div class="line">	</div><div class="line"><span class="comment"># event 事件区</span></div><div class="line">events &#123;</div><div class="line">	worker_connections  1024;  单个进程并发连接数,总共的并发连接等于worker_processes乘以1024</div><div class="line">&#125;</div><div class="line">	</div><div class="line"><span class="comment"># http 服务配置区域,如果某个选项参数写在http区域中,则表示对所有的server都生效,如果是写到对应的某个server下,则表示只对该server生效</span></div><div class="line">http &#123;</div><div class="line">		</div><div class="line">	include       mime.types;</div><div class="line">	default_type  application/octet-stream;</div><div class="line">	sendfile        on;</div><div class="line">	keepalive_timeout  65;	</div><div class="line"><span class="built_in">	server </span>&#123;	一个server标签就是一个虚拟主机</div><div class="line">		listen       80;	默认监听的web端口</div><div class="line">		server_name  localhost;	域名</div><div class="line">			</div><div class="line">		location / &#123;  网站根目录位置</div><div class="line">			root   html;</div><div class="line">			index  index.html index.htm;  主页索引文件</div><div class="line">		&#125;	</div><div class="line">	&#125;	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>00x9 在nginx中配置基于各类形式虚拟主机,像下面这样,我们可以先直接在nginx主配置文件中进行配置:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> mkdir /usr/<span class="built_in">local</span>/nginx/html/&#123;www,bbs,blog,status&#125; -p	准备好相应的网站目录</span></div><div class="line"><span class="meta">#</span><span class="bash"> tree /usr/<span class="built_in">local</span>/nginx/html/		检查目录是否创建好</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"welocme to www.rootkit.org"</span> &gt; /usr/<span class="built_in">local</span>/nginx/html/www/index.html</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"welocme to bbs.rootkit.org"</span> &gt; /usr/<span class="built_in">local</span>/nginx/html/bbs/index.html</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"welocme to blog.rootkit.org"</span> &gt; /usr/<span class="built_in">local</span>/nginx/html/blog/index.html</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"welocme to status.rootkit.org"</span> &gt; /usr/<span class="built_in">local</span>/nginx/html/status/index.html</span></div></pre></td></tr></table></figure></p>
<p>00x10 基于域名的虚拟主机[访问不同的域名会被定位到不同的网站目录中],其实非常简单,只要改下server标签中对应的字段,只不过实际中,可能还需要你添加好相应的A记录,另外,如果直接输入ip,默认会访问到www,貌似是按顺序读的:<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</div><div class="line"><span class="section">events</span> &#123;</div><div class="line">	<span class="attribute">worker_connections</span>  <span class="number">1024</span>;</div><div class="line">&#125;</div><div class="line"><span class="section">http</span> &#123;</div><div class="line">	<span class="attribute">include</span>       mime.types;</div><div class="line">	<span class="attribute">default_type</span>  application/octet-stream;</div><div class="line">	<span class="attribute">sendfile</span>        <span class="literal">on</span>;</div><div class="line">	<span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</div><div class="line">	</div><div class="line">	<span class="section">server</span> &#123;</div><div class="line">		<span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">		<span class="attribute">server_name</span>  www.rootkit.org;</div><div class="line">		<span class="attribute">location</span> / &#123;</div><div class="line">			<span class="attribute">root</span>   html/www;</div><div class="line">			<span class="attribute">index</span>  index.html index.htm;</div><div class="line">		&#125;</div><div class="line">		<span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</div><div class="line">		<span class="attribute">location</span> = /50x.html &#123;</div><div class="line">			<span class="attribute">root</span>   html/www;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="section">server</span> &#123;</div><div class="line">		<span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">		<span class="attribute">server_name</span>  bbs.rootkit.org;</div><div class="line">		<span class="attribute">location</span> / &#123;</div><div class="line">			<span class="attribute">root</span>   html/bbs;</div><div class="line">			<span class="attribute">index</span>  index.html index.htm;</div><div class="line">		&#125;</div><div class="line">		<span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</div><div class="line">		<span class="attribute">location</span> = /50x.html &#123;</div><div class="line">			<span class="attribute">root</span>   html/bbs;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="section">server</span> &#123;</div><div class="line">		<span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">		<span class="attribute">server_name</span>  blog.rootkit.org;</div><div class="line">		<span class="attribute">location</span> / &#123;</div><div class="line">			<span class="attribute">root</span>   html/blog;</div><div class="line">			<span class="attribute">index</span>  index.html index.htm;</div><div class="line">		&#125;</div><div class="line">		<span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</div><div class="line">		<span class="attribute">location</span> = /50x.html &#123;</div><div class="line">			<span class="attribute">root</span>   html/blog;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="section">server</span> &#123;</div><div class="line">		<span class="attribute">listen</span>       <span class="number">80</span>;</div><div class="line">		<span class="attribute">server_name</span>  status.rootkit.org;</div><div class="line">		<span class="attribute">location</span> / &#123;</div><div class="line">			<span class="attribute">root</span>   html/status;</div><div class="line">			<span class="attribute">index</span>  index.html index.htm;</div><div class="line">		&#125;</div><div class="line">		<span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</div><div class="line">		<span class="attribute">location</span> = /50x.html &#123;</div><div class="line">			<span class="attribute">root</span>   html/status;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">C:\Windows\System32\drivers\etc\hosts</div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t	先检查配置,没问题再重启</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -c /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf	有时候可能会提示找不到pid,手工加载配置文件,然后再重新载入就好了</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span></div></pre></td></tr></table></figure>
<p>00x11 基于端口的虚拟主机[访问不同的端口会被定位到不同的网站目录中],有些目标的网站后台,oa入口,等等……都会跑在一些非默认的web端口上,所以实际渗透中,顺手多试几个端口,也许会有惊喜:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">worker_processes  1;</div><div class="line">events &#123;</div><div class="line">	worker_connections  1024;</div><div class="line">&#125;</div><div class="line">http &#123;</div><div class="line">	include       mime.types;</div><div class="line">	default_type  application/octet-stream;</div><div class="line">	sendfile        on;</div><div class="line">	keepalive_timeout  65;</div><div class="line"><span class="built_in">	server </span>&#123;</div><div class="line">		listen       80;</div><div class="line">		server_name  localhost;	不需要在指定server_name,全部默认localhost即可</div><div class="line">		location / &#123;</div><div class="line">			root   html/www;</div><div class="line">			index  index.html index.htm;</div><div class="line">		&#125;</div><div class="line">		error_page   500 502 503 504  /50x.html;</div><div class="line">		location = /50x.html &#123;</div><div class="line">			root   html/www;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"><span class="built_in">	server </span>&#123;</div><div class="line">		listen       81;</div><div class="line">		server_name  localhost;</div><div class="line">		location / &#123;</div><div class="line">			root   html/bbs;</div><div class="line">			index  index.html index.htm;</div><div class="line">		&#125;</div><div class="line">		error_page   500 502 503 504  /50x.html;</div><div class="line">		location = /50x.html &#123;</div><div class="line">			root   html/bbs;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"><span class="built_in">	server </span>&#123;</div><div class="line">		listen       82;</div><div class="line">		server_name  localhost;</div><div class="line">		location / &#123;</div><div class="line">			root   html/blog;</div><div class="line">			index  index.html index.htm;</div><div class="line">		&#125;</div><div class="line">		error_page   500 502 503 504  /50x.html;</div><div class="line">		location = /50x.html &#123;</div><div class="line">			root   html/blog;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t	还是先检查,没问题再重启</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span></div></pre></td></tr></table></figure>
<p>00x12 基于ip的虚拟主机[需要有多块网卡支持,访问不同的ip会被定位到不同的网站目录下,实际中用的非常少,自己在测试时,貌似还有一些小问题,生产环境中用的比较少,所以也不必太过纠结]:<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /usr/local/nginx/conf/nginx.conf </span></div><div class="line">	</div><div class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</div><div class="line"><span class="section">events</span> &#123;</div><div class="line">	<span class="attribute">worker_connections</span>  <span class="number">1024</span>;</div><div class="line">&#125;</div><div class="line"><span class="section">http</span> &#123;</div><div class="line">	<span class="attribute">include</span>       mime.types;</div><div class="line">	<span class="attribute">default_type</span>  application/octet-stream;</div><div class="line">	<span class="attribute">sendfile</span>        <span class="literal">on</span>;</div><div class="line">	<span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</div><div class="line">	<span class="section">server</span> &#123;</div><div class="line">		<span class="attribute">listen</span>       <span class="number">192.168.3.110:80</span>;</div><div class="line">		<span class="attribute">server_name</span>  localhost;</div><div class="line">		<span class="attribute">location</span> / &#123;</div><div class="line">			<span class="attribute">root</span>   html/www;</div><div class="line">			<span class="attribute">index</span>  index.html index.htm;</div><div class="line">		&#125;</div><div class="line">		<span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</div><div class="line">		<span class="attribute">location</span> = /50x.html &#123;</div><div class="line">			<span class="attribute">root</span>   html/www;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="section">server</span> &#123;</div><div class="line">		<span class="attribute">listen</span>       <span class="number">192.168.3.119:80</span>;</div><div class="line">		<span class="attribute">server_name</span>  localhost;</div><div class="line">		<span class="attribute">location</span> / &#123;</div><div class="line">		<span class="attribute">root</span>   html/bbs;</div><div class="line">			<span class="attribute">index</span>  index.html index.htm;</div><div class="line">		&#125;</div><div class="line">		<span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</div><div class="line">		<span class="attribute">location</span> = /50x.html &#123;</div><div class="line">			<span class="attribute">root</span>   html/bbs;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="section">server</span> &#123;</div><div class="line">		<span class="attribute">listen</span>       <span class="number">192.168.3.120:80</span>;</div><div class="line">		<span class="attribute">server_name</span>  localhost;</div><div class="line">		<span class="attribute">location</span> / &#123;</div><div class="line">			<span class="attribute">root</span>   html/blog;</div><div class="line">			<span class="attribute">index</span>  index.html index.htm;</div><div class="line">		&#125;</div><div class="line">		<span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</div><div class="line">		<span class="attribute">location</span> = /50x.html &#123;</div><div class="line">			<span class="attribute">root</span>   html/blog;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t	先检查,务必要没问题再重启</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span></div></pre></td></tr></table></figure>
<p>00x13 利用 nginx 的include功能简化nginx主配置文件:<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># <span class="keyword">mkdir</span> /usr/<span class="keyword">local</span>/nginx/<span class="keyword">conf</span>/extra		创建扩展配置目录</div><div class="line"># touch /usr/<span class="keyword">local</span>/nginx/<span class="keyword">conf</span>/extra/&#123;www.<span class="keyword">conf</span>,bbs.<span class="keyword">conf</span>,blog.<span class="keyword">conf</span>,status.<span class="keyword">conf</span>&#125;	创建配置文件</div><div class="line"># tree /usr/<span class="keyword">local</span>/nginx/<span class="keyword">conf</span>/extra/		再次检查目录是否存在</div></pre></td></tr></table></figure></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># vi /usr/<span class="keyword">local</span>/nginx/<span class="keyword">conf</span>/nginx.<span class="keyword">conf</span></div><div class="line">worker_processes  1;</div><div class="line">events &#123;</div><div class="line">	worker_connections  1024;</div><div class="line">&#125;</div><div class="line">http &#123;	<span class="keyword">include</span>功能一般都是加在http区域中</div><div class="line">	<span class="keyword">include</span>       mime.types;</div><div class="line">	default_type  application/octet-stream;</div><div class="line">	sendfile        <span class="keyword">on</span>;</div><div class="line">	keepalive_timeout  65;</div><div class="line"></div><div class="line">	# vhost config</div><div class="line">	<span class="keyword">include</span> extra/www.<span class="keyword">conf</span>;</div><div class="line">	<span class="keyword">include</span> extra/bbs.<span class="keyword">conf</span>;</div><div class="line">	<span class="keyword">include</span> extra/blog.<span class="keyword">conf</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /usr/local/nginx/conf/extra/www.conf</span><span class="built_in"></span></div><div class="line">server &#123;</div><div class="line">	listen       80;</div><div class="line">	server_name  www.rootkit.org;</div><div class="line">	location / &#123;</div><div class="line">		root   html/www;</div><div class="line">		index  index.html index.htm;</div><div class="line">	&#125;</div><div class="line">	error_page   500 502 503 504  /50x.html;</div><div class="line">		location = /50x.html &#123;</div><div class="line">		root   html/www;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /usr/local/nginx/conf/extra/bbs.conf</span><span class="built_in"></span></div><div class="line">server &#123;</div><div class="line">	listen       80;</div><div class="line">	server_name  bbs.rootkit.org;</div><div class="line">	location / &#123;</div><div class="line">		root   html/bbs;</div><div class="line">		index  index.html index.htm;</div><div class="line">	&#125;</div><div class="line">	error_page   500 502 503 504  /50x.html;</div><div class="line">		location = /50x.html &#123;</div><div class="line">		root   html/bbs;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /usr/local/nginx/conf/extra/blog.conf</span><span class="built_in"></span></div><div class="line">server &#123;</div><div class="line">	listen       80;</div><div class="line">	server_name  blog.rootkit.org;</div><div class="line">	location / &#123;</div><div class="line">		root   html/blog;</div><div class="line">		index  index.html index.htm;</div><div class="line">	&#125;</div><div class="line">	error_page   500 502 503 504  /50x.html;</div><div class="line">		location = /50x.html &#123;</div><div class="line">		root   html/blog;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /usr/local/nginx/conf/extra/status.conf</span><span class="built_in"></span></div><div class="line">server &#123;</div><div class="line">	listen       80;</div><div class="line">	server_name  status.rootkit.org;</div><div class="line">	location / &#123;</div><div class="line">		root   html/status;</div><div class="line">		index  index.html index.htm;</div><div class="line">	&#125;</div><div class="line">	error_page   500 502 503 504  /50x.html;</div><div class="line">		location = /50x.html &#123;</div><div class="line">		root   html/status;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload有时候重载可能不太好使,那就直接先停掉,然后再起来</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s stop</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx</span></div></pre></td></tr></table></figure>
<p>00x14 利用 nginx 进行别名设置 [实际中,可能会用rewrite跳转更多一些,只不过中间要多发一次请求,压力稍大了一点],其实非常简单,如下:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /usr/local/nginx/conf/extra/www.conf</span><span class="built_in"></span></div><div class="line">server &#123;</div><div class="line">	listen       80;</div><div class="line">	server_name  www.rootkit.org rootkit.org rootkit.net;	空格隔开,后面可连续跟上多个域名,当访问rootkit.org时就相当于访问www.rootkit.org</div><div class="line">	location / &#123;</div><div class="line">		root   html/www;</div><div class="line">		index  index.html index.htm;</div><div class="line">	&#125;</div><div class="line">	error_page   500 502 503 504  /50x.html;</div><div class="line">	location = /50x.html &#123;</div><div class="line">		root   html/www;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span></div></pre></td></tr></table></figure>
<p>00x15 nginx 对某单个站点开启状态监控:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /usr/local/nginx/conf/nginx.conf</span></div><div class="line">worker_processes  1;</div><div class="line">events &#123;</div><div class="line">	worker_connections  1024;</div><div class="line">&#125;</div><div class="line">http &#123;</div><div class="line">	include       mime.types;</div><div class="line">	default_type  application/octet-stream;</div><div class="line">	sendfile        on;</div><div class="line">	keepalive_timeout  65;</div><div class="line"></div><div class="line">	# vhost<span class="built_in"> config</span></div><div class="line">	include extra/www.conf;</div><div class="line">	include extra/bbs.conf;</div><div class="line">	include extra/blog.conf;</div><div class="line">	include extra/status.conf;需要单独包含此配置文件</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># vi /usr/local/nginx/conf/extra/status.conf</span><span class="built_in"></span></div><div class="line">server &#123;</div><div class="line">	listen       80;</div><div class="line">	server_name  status.rootkit.org;</div><div class="line">	location / &#123;</div><div class="line">		root   html/status;</div><div class="line">		index  index.html index.htm;</div><div class="line">		stub_status on; 开启nginx自身的状态监控</div><div class="line">		access_log off;</div><div class="line">	&#125;</div><div class="line">	error_page   500 502 503 504  /50x.html;</div><div class="line">	location = /50x.html &#123;</div><div class="line">		root   html/status;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span></div></pre></td></tr></table></figure>
<p>00x16 nginx 错误日志处理:<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># vi /usr/<span class="keyword">local</span>/nginx/<span class="keyword">conf</span>/nginx.<span class="keyword">conf</span></div><div class="line">worker_processes  1;</div><div class="line">error_log logs/<span class="keyword">error</span>.<span class="keyword">log</span> <span class="keyword">error</span>; 这里是全局的错误日志,也就是说对所有server生效,当然,你也可以把它单独放在某个server中只记录指定server的错误日志,实际环境中,最好把它单独放到某个server中,这样后续便于取证分析</div><div class="line">	</div><div class="line">events &#123;</div><div class="line">	worker_connections  1024;</div><div class="line">&#125;</div><div class="line">http &#123;</div><div class="line">	<span class="keyword">include</span>       mime.types;</div><div class="line">	default_type  application/octet-stream;</div><div class="line">	sendfile        <span class="keyword">on</span>;</div><div class="line">	keepalive_timeout  65;</div><div class="line">		</div><div class="line">	# vhost config</div><div class="line">	<span class="keyword">include</span> extra/www.<span class="keyword">conf</span>;</div><div class="line">	<span class="keyword">include</span> extra/bbs.<span class="keyword">conf</span>;</div><div class="line">	<span class="keyword">include</span> extra/blog.<span class="keyword">conf</span>;</div><div class="line"></div><div class="line">	# status monitor</div><div class="line">	<span class="keyword">include</span> extra/status.<span class="keyword">conf</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span></div><div class="line"><span class="meta">#</span><span class="bash"> cat /usr/<span class="built_in">local</span>/nginx/logs/error.log</span></div></pre></td></tr></table></figure>
<p>00x17 关于 ngnix 访问日志格式设置 [最好单独针对每个server进行配置,如果是在http全局配置中设定,则所有server都遵守此格式,不推荐那么做,日志可能会非常大,后期审计困难]:<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /usr/local/nginx/conf/nginx.conf编辑主配置文件定义好日志格式</span></div><div class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</div><div class="line"><span class="attribute">error_log</span> logs/error.log <span class="literal">error</span>;</div><div class="line"></div><div class="line"><span class="section">events</span> &#123;</div><div class="line">	<span class="attribute">worker_connections</span>  <span class="number">1024</span>;</div><div class="line">&#125;</div><div class="line"><span class="section">http</span> &#123;</div><div class="line">	<span class="attribute">include</span>       mime.types;</div><div class="line">	<span class="attribute">default_type</span>  application/octet-stream;</div><div class="line">	<span class="attribute">sendfile</span>        <span class="literal">on</span>;</div><div class="line">	<span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</div><div class="line"></div><div class="line">	<span class="comment"># access_log config在http区域中定义好访问日志格式</span></div><div class="line">	<span class="attribute">log_format</span> main <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span>  [<span class="variable">$time_local</span>]  '</span> </div><div class="line">	<span class="string">' "<span class="variable">$request</span>"  <span class="variable">$status</span>  <span class="variable">$body_bytes_sent</span>  '</span></div><div class="line">	<span class="string">' "<span class="variable">$http_referer</span>"  "<span class="variable">$http_user_agent</span>"  "<span class="variable">$http_x_forwarded_for</span>" '</span>;</div><div class="line"></div><div class="line">	<span class="comment"># vhost config</span></div><div class="line">	<span class="attribute">include</span> extra/www.conf;</div><div class="line">	<span class="attribute">include</span> extra/bbs.conf;</div><div class="line">	<span class="attribute">include</span> extra/blog.conf;</div><div class="line">	<span class="attribute">include</span> extra/status.conf;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># vi /usr/local/nginx/conf/extra/www.conf</span><span class="built_in"></span></div><div class="line">server &#123;</div><div class="line">	listen       80;</div><div class="line">	server_name  www.rootkit.org rootkit.org;</div><div class="line">	location / &#123;</div><div class="line">		root   html/www;</div><div class="line">		index  index.html index.htm;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	access_log logs/access_www.log main;调用前面的日志格式,可以在所有的虚拟主机中定义此配置</div><div class="line"></div><div class="line">	error_page   500 502 503 504  /50x.html;</div><div class="line">	location = /50x.html &#123;</div><div class="line">		root   html/www;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span></div><div class="line"><span class="meta">#</span><span class="bash"> &gt; /usr/<span class="built_in">local</span>/nginx/logs/access_www.log</span></div><div class="line"><span class="meta">#</span><span class="bash"> tail -f /usr/<span class="built_in">local</span>/nginx/logs/access_www.log</span></div></pre></td></tr></table></figure>
<p>00x18 让 nginx 访问日志按天/小时 [访问量特别大的时候可以按小时]自动轮询[也可用awstats日志工具],切割小脚本如下[最好丢到计划任务中,每晚0点整处理],然后打包自动推到日志服务器上即可:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> vi /server/scripts/nginx_access_log.sh</span></div></pre></td></tr></table></figure></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/bin/bash</span></div><div class="line"></div><div class="line">dateformat=`date +%Y%m%d`</div><div class="line">basedir=<span class="string">"/usr/local/nginx"</span></div><div class="line">nginxlogdir=<span class="string">"$basedir/logs"</span></div><div class="line">logname=<span class="string">"access_www"</span>  	如果有多个虚拟机主机,在对应的server加上该日志选项,然后循环一下就好了</div><div class="line">[ -s <span class="variable">$nginxlogdir</span> ] &amp;&amp; cd <span class="variable">$nginxlogdir</span> || <span class="keyword">exit</span> <span class="number">1</span></div><div class="line">[ -f <span class="variable">$&#123;logname&#125;</span>.log ] || <span class="keyword">exit</span> <span class="number">1</span></div><div class="line"><span class="regexp">/bin/m</span>v <span class="variable">$&#123;logname&#125;</span>.log <span class="variable">$&#123;dateformat&#125;</span>_<span class="variable">$&#123;logname&#125;</span>.log  把日志按时间改下名</div><div class="line"><span class="variable">$basedir</span><span class="regexp">/sbin/</span>nginx -s reload</div></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> sh nginx_access_log.sh</span></div><div class="line"><span class="meta">#</span><span class="bash"> crontab -e</span></div><div class="line">	00 00 * * * /bin/sh /server/scripts/nginx_access_log.sh		每天凌晨零点零分执行日志轮询操作</div><div class="line"><span class="meta">#</span><span class="bash"> crontab -l</span></div><div class="line"><span class="meta">#</span><span class="bash"> date -s <span class="string">"2017-06-25 23:59:55"</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> ls -l /usr/<span class="built_in">local</span>/nginx/logs/</span></div><div class="line"><span class="meta">#</span><span class="bash"> cat /usr/<span class="built_in">local</span>/nginx/logs/20170626_access_www.log		注意,这里保存的是前一天的日志</span></div></pre></td></tr></table></figure>
<p>00x19 利用nginx自带的rewrite功能,重定向指定的url:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># vi /usr/local/nginx/conf/extra/www.conf</div><div class="line">server &#123;</div><div class="line">	<span class="section">listen</span>       <span class="number">80</span>;</div><div class="line">	server_name  www.rootkit.org rootkit.org;</div><div class="line">	location / &#123;</div><div class="line">		root   html/www;</div><div class="line">		index  index.html index.htm;</div><div class="line">		rewrite /admin/succeed.html  /hellohacker.html permanent;	将访问指定目录下的指定文件,permanent表示永久重定向到指定页面[<span class="number">301</span>跳转],当然,这里只是一个非常简单的样例,'当有人访问后台,让他跳到指定页面上',实际中你可以根据自己的实际需求配置更灵活的规则</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	access_log logs/access_www.log main;</div><div class="line">	error_page   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /<span class="number">50</span>x.html;</div><div class="line">	location = /<span class="number">50</span>x.html &#123;</div><div class="line">		root   html/www;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -t</span></div><div class="line"><span class="meta">#</span><span class="bash"> /usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload</span></div></pre></td></tr></table></figure>
<p>00x20 rewrite基本语法 [其实就是perl正则]:</p>
<p>00x21 nginx 自身提供的负载均衡功能:</p>
<p>00x22 了解 select 和 epoll模型:<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">nginx</span>  支持<span class="literal">epoll</span>模型,所谓的<span class="literal">epoll</span>模型即通过事先已经规划好的id可直接命中目标,效率相对较高</div><div class="line">apache 支持<span class="literal">select</span>模型,所谓的<span class="literal">select</span>模型则是挨个遍历,效率相对比较低</div></pre></td></tr></table></figure></p>
<p>00x23 nginx 简单安全优化,同样,这也是一个非常大的话题,后续会详细单聊:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>,以一个系统伪用户身份来运行nginx服务,其实,在上面的编译安装阶段,我们就是以nginx这个伪用户身份进行的,所以,如果你跟我一样,此步骤可以忽略	</div><div class="line"><span class="number">2</span>,网站目录文件属性全部改为,root所属主,root所属组,nginx则会映射到其他人的权限下,并将网站目录权限改为<span class="number">755</span>,文件权限<span class="number">644</span></div><div class="line"><span class="number">3</span>,禁止目录遍历,其实nginx默认就是禁止目录遍历的[可以把此选项加在全局http配置中]</div><div class="line"><span class="number">4</span>,限制在上传目录[也可同时限制多个目录]中执行脚本[可再对应的server标签中进行配置],这里写的不全,大家可以自己补一下,另外,这里的限制并不是很靠谱,只有在文件系统层面限制住才是真正的限制</div><div class="line"><span class="number">5</span>,禁止外部访问各种敏感文件,如,备份文件[.bak],数据库文件[.sql],配置文件[.conf]等,这里的文件后缀类型可以按你自己的实际需求加……</div><div class="line"><span class="number">6</span>,禁止显示当前nginx版本号[加到http全局配置中]</div><div class="line"><span class="number">7</span>,将所有异常的状态码全部重定向到指定页面中[在指定的server中进行配置]</div><div class="line"><span class="number">8</span>,设置timeout值一定程度上缓解CC [加到http全局配置中,暂时还有些问题]</div><div class="line"><span class="number">9</span>,限制客户端的访问方法,比如,只允许GET,POST,HEAD,其它的请求方法都直接丢给<span class="number">404</span></div><div class="line"><span class="number">10</span>,做好日志处理,日后方便审计,关于日志轮询前面已经提供脚本</div><div class="line"><span class="number">11</span>,针对性限制ip,如下表示限制整个网段访问</div><div class="line"><span class="number">12</span>,利用lua自定义针对一些高危漏洞利用的规则集,如,sql注入,xss,执行,远程包含等[实现简易waf功能]……</div><div class="line"><span class="number">13</span>,修复nginx解析漏洞[在server中配置]</div><div class="line">	第一种方法,将php.ini中的cgi.fix_pathinfo值设为<span class="number">0</span></div><div class="line">	第二种方法,写条简单的规则,限制脚本执行</div><div class="line"><span class="number">14</span>,限制用户连接数[暂时还有些问题]</div><div class="line"><span class="number">15</span>,自定义缓存大小限制缓冲区溢出</div><div class="line"><span class="number">16</span>,限制访问后台入口,比如,只允许那些ip可以访问,或者你也可以设置访问验证,另外,尽量不要用一些比较常见的后台目录名,容易被猜到,比如,admin,manage,cms,system,sysadm……</div><div class="line">......</div></pre></td></tr></table></figure></p>
<p><br><br>更多,待续……</p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/演练环境搭建/">#演练环境搭建</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>

</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">

<center>如果有朋友需要优质vps,可以去<a href="http://www.laoxuehost.com/vps/" target="_blank">老薛</a>买,异常稳定,本人已自用多年,使用下面的优惠码,会有 <font color="red">25% </font>的折扣哦...</center><br>
至少,在同等质量的vps中,已经算是非常好的了,起码自己平时 youtube 1080 基本是没什么问题<br>
<br>
<a href="http://www.laoxuehost.com/vps/" target="_blank" > 购买老薛vps </a> &nbsp;&nbsp;&nbsp;&nbsp; 优惠码: <font color="red">nuddle123</font><br>
<br><a href="/img/laoxue.png" target="_blank">优惠码具体使用方法</a><br>
<br>
<span>另,有偿提供各类服务搭建,配置加固[lamp,lnmp,vpn...],服务器代维<font color="red"> &nbsp;&nbsp;klionsec@gmail.com</span><br>
<br>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">博客累计访问共 <span id="busuanzi_value_site_pv"></span> 次</span>
<span id="busuanzi_container_site_uv">
访客数累计 <span id="busuanzi_value_site_uv"></span> 人
</span>
<span id="showDays"></span>
<script>
var birthDay = new Date("12/20/2014");
var now = new Date();
var duration = now.getTime() - birthDay.getTime(); 
var total= Math.floor(duration / (1000 * 60 * 60 * 24));
document.getElementById("showDays").innerHTML = " 其实博客已默默坚挺了 "+total+" 天";
</script>
<br>
<br>
有多年实战渗透经验积累[大中小型网络] + 娴熟的底层开发能力 + 熟练的协议分析能力 + 有多个大中型安全架构实际设计部署经验 + 良好的逆向分析能力[一定的0day挖掘能力] = 安全架构师
<br>
<br>
<font size=6 color="white">唯一不变的,就是一直在变</font>
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/klionsec">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:klionsec@gmail.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    <h2>blog by klion</h2>
                </div>
            </div>
        </div>
    </div>
		<audio autoplay="autoplay">
		<source src="/img/Good_Goodbye.mp3" type="audio/mpeg" />
		</audio>
</footer>



<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>