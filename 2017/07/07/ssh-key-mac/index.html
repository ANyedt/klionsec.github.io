<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="知道自己想要做什么,比怎么做更重要">
    

    <!--Author-->
    
        <meta name="author" content="klion">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="基于原始 ssh key 的分发机实现"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="知道自己想要做什么,比怎么做更重要" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="klion&#39;s blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>基于原始 ssh key 的分发机实现 - klion&#39;s blog</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    about me
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    blogs
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2017/07/07/ssh-key-mac/">
                基于原始 ssh key 的分发机实现
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-07-07</span>
            
            
            
                <span class="category">
                    <a href="/categories/env/">env</a>
                </span>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <p><br><br>00x1 基于最原始的 SSH key 实现批量ssh管理 [适合较小规模集群场景,100台机器以内]:<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>,批量分发文件 [配置管理]</div><div class="line"><span class="number">2</span>,批量执行命令</div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>00x2 基于SSH key 的批量ssh管理具体实现:<br>已经相对比较成熟的相关产品,后续还会再专门针对每个单独说:<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">saltstack</span></span>,puppet...</div></pre></td></tr></table></figure></p>
<p>00x3 批量在所有机器上创建普通用户,主要用此用户身份来进行各种分发操作 [root权限过高,太危险,只要分发机一旦被攻陷,所有机器也就随之沦陷了,建议必要的时候用sudo或者suid(其实也不推荐)来进行高权限操作]<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> useradd sysadm</span></div><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"admin"</span> | passwd --stdin sysadm</span></div></pre></td></tr></table></figure></p>
<p>00x4 先在分发机上创建好密钥对<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> su - sysadm</span></div><div class="line"><span class="meta">$</span><span class="bash"> ssh-keygen -t dsa	一路回车即可</span></div><div class="line"><span class="meta">$</span><span class="bash"> ls -l .ssh/</span></div><div class="line">	id_rsa		私钥[钥匙]</div><div class="line">	id_rsa.pub	公钥[锁],把公钥分发给所有要ssh的机器</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>00x5 批量往所有机器上分发公钥 [把锁给所有人,钥匙自己拿着], 如果是第一次部署,机器比较多多的情况下,可以用expect方式<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ ssh-copy-id -<span class="selector-tag">i</span> ~/.ssh/id_dsa<span class="selector-class">.pub</span> <span class="string">"-p 22 sysadm@192.168.3.177"</span></div><div class="line">$ ssh-copy-id -<span class="selector-tag">i</span> ~/.ssh/id_dsa<span class="selector-class">.pub</span> <span class="string">"-p 22 sysadm@192.168.3.51"</span></div><div class="line">$ ssh-copy-id -<span class="selector-tag">i</span> ~/.ssh/id_dsa<span class="selector-class">.pub</span> <span class="string">"-p 22 sysadm@192.168.3.61"</span></div><div class="line">$ ssh-copy-id -<span class="selector-tag">i</span> ~/.ssh/id_dsa<span class="selector-class">.pub</span> <span class="string">"-p 22 sysadm@192.168.3.41"</span></div><div class="line">$ ssh-copy-id -<span class="selector-tag">i</span> ~/.ssh/id_dsa<span class="selector-class">.pub</span> <span class="string">"-p 22 sysadm@192.168.3.71"</span></div><div class="line">$ ssh-copy-id -<span class="selector-tag">i</span> ~/.ssh/id_dsa<span class="selector-class">.pub</span> <span class="string">"-p 22 sysadm@192.168.3.91"</span></div><div class="line">$ ssh-copy-id -<span class="selector-tag">i</span> ~/.ssh/id_dsa<span class="selector-class">.pub</span> <span class="string">"-p 22 sysadm@192.168.3.81"</span></div></pre></td></tr></table></figure></p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">ls</span> <span class="string">.ssh/authorized_keys</span>  这是实际到目标机器上的文件名,只不过过去的时候被改名了,其实跟id_dsa.pub文件中的内容是一模一样的</div></pre></td></tr></table></figure>
<p>00x6 批量远程执行命令:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ssh -p22 sysadm@<span class="number">192.168</span><span class="number">.3</span><span class="number">.177</span> hostname</div><div class="line">$ ssh -p22 sysadm@<span class="number">192.168</span><span class="number">.3</span><span class="number">.81</span> hostname</div></pre></td></tr></table></figure></p>
<p>00x7 批量分发文件:<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>scp -P22 /etc/hosts sysadm<span class="variable">@192</span>.<span class="number">168.3</span>.<span class="number">177</span><span class="symbol">:~</span>	直接往对方sysadm用户的家目录下发</div></pre></td></tr></table></figure></p>
<p>00x8 通过脚本实现批量文件分发,批量执行系统命令:<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">####################### 批量分发文件 ###############################</div><div class="line">#!/bin/bash</div><div class="line"># ssh key commond / file send</div><div class="line"><span class="keyword">if</span> [ $# -ne <span class="number">1</span> ];then</div><div class="line">	echo <span class="string">"use: sh ssh_key.sh file|dir"</span></div><div class="line">	exit <span class="number">1</span></div><div class="line">fi</div><div class="line"></div><div class="line">for n <span class="keyword">in</span> <span class="number">177</span> <span class="number">51</span> <span class="number">61</span> <span class="number">41</span> <span class="number">71</span> <span class="number">91</span> <span class="number">81</span></div><div class="line">do</div><div class="line">	scp -P22 -r $<span class="number">1</span> sysadm@<span class="number">192.168</span><span class="number">.3</span>.$n:~ &amp;&gt;/dev/null</div><div class="line">	<span class="keyword">if</span> [ $? -eq <span class="number">0</span> ];then</div><div class="line">		echo -e <span class="string">"$n is ok \n"</span></div><div class="line">	else</div><div class="line">		echo -e <span class="string">"$n is failed \n"</span></div><div class="line">	fi</div><div class="line">done</div></pre></td></tr></table></figure></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> sh ssh_key.sh /etc/hosts</span></div></pre></td></tr></table></figure>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">####################### 批量执行指令 ###############################</div><div class="line">#!/bin/bash</div><div class="line"># ssh key commond / file send</div><div class="line"><span class="keyword">if</span> [ $# -ne <span class="number">1</span> ];then</div><div class="line">	echo <span class="string">"use: sh ssh_cmd.sh cmd"</span></div><div class="line">	exit <span class="number">1</span></div><div class="line">fi</div><div class="line">	</div><div class="line">for n <span class="keyword">in</span> <span class="number">177</span> <span class="number">51</span> <span class="number">61</span> <span class="number">41</span> <span class="number">71</span> <span class="number">91</span> <span class="number">81</span></div><div class="line">do</div><div class="line">	echo -e <span class="string">"\n--------------------------------------------------------------------"</span></div><div class="line">	ssh -p22 sysadm@<span class="number">192.168</span><span class="number">.3</span>.$n $<span class="number">1</span></div><div class="line">done</div></pre></td></tr></table></figure>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">sh </span>ssh_cmd.<span class="keyword">sh </span><span class="string">"/sbin/ifconfig -a"</span></div></pre></td></tr></table></figure>
<p>00x9 也可利用rsync隧道工作模式配合ssh key 实现免密码备份,不过实际中基本不会这么做,太危险:<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># rsync -avzP -e <span class="string">'ssh -p 22'</span> <span class="regexp">/tmp/</span> sysadm@<span class="number">192.168</span>.<span class="number">3.177</span>:<span class="regexp">/tmp/</span></div></pre></td></tr></table></figure></p>
<p>00x10 分发过程中需要注意的一些权限的问题:<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>,利用root的ssh <span class="type">key</span>来做,非常危险,分发机一旦被攻陷,其它的机器也就跟着全部沦陷了</div><div class="line"><span class="number">2</span>,让普通用户利用sudo来执行特权操作,还是有些危险</div><div class="line"><span class="number">3</span>,也可以用suid来控制,对要执行的命令进行suid,实际中最好还是不要用,也比较危险</div><div class="line"><span class="number">4</span>,推荐利用各种第三方工具,比如,puppet,saltstack</div></pre></td></tr></table></figure></p>
<p>00x11 利用sudo的方式批量执行指令,实际中写成脚本即可:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"sysadm  ALL=(ALL) NOPASSWD:/usr/bin/rsync"</span> &gt;&gt; /etc/sudoers </span></div><div class="line"><span class="meta">#</span><span class="bash"> visudo -c</span></div><div class="line"><span class="meta">#</span><span class="bash"> grep sysadm /etc/sudoers</span></div><div class="line"><span class="meta">#</span><span class="bash"> scp -P22 -r /etc/issue sysadm@192.168.3.177:~		先把它推到sysadm家目录下</span></div><div class="line"><span class="meta">#</span><span class="bash"> ssh -t sysadm@192.168.3.177 sudo rsync issue /etc/	这时候再用sudo来进行高权限操作,说实话,既然都能控制你的核心系统配置文件了,创建个用户又有多难呢,所以,我觉得这样也并不安全</span></div></pre></td></tr></table></figure></p>
<p>00x12 至于利用suid的方式进行分发,就非常简单了,只需要把你经常要用的一些命令加上suid权限属性就好了,,注意有些能随意操作系统配置的工具千万不要给suid,否则就是自己给别人留了个后门,只需要find下,就什么都有了<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> chmod 4755 /usr/bin/rsync		让其具有suid功能</span></div><div class="line"><span class="meta">#</span><span class="bash"> ls -l /usr/bin/rsync</span></div></pre></td></tr></table></figure></p>
<p>00x13 最后,利用定时任务执行各种分发任务:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> crontab -e</span></div></pre></td></tr></table></figure></p>
<p>00x14 分发机自身的安全问题:<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">严禁直接把分发机暴露在公网中</div><div class="line">只允许特定的跳板机登陆到分发机</div><div class="line">.....</div></pre></td></tr></table></figure></p>
<p><br><br>更多,待续….</p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/演练环境搭建/">#演练环境搭建</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>

</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">

<center>如果有朋友需要优质vps,可以去<a href="http://www.laoxuehost.com/vps/" target="_blank">老薛</a>买,异常稳定,本人已自用多年,使用下面的优惠码, <font color="red">25% </font>的折扣哦...</center><br>
至少,在同等质量的vps中,已经算是非常好的了,起码自己平时 youtube 1080 基本是没什么问题<br>
<br>
<a href="http://www.laoxuehost.com/vps/" target="_blank" > 购买老薛vps </a> &nbsp;&nbsp;&nbsp;&nbsp; 优惠码: <font color="red">nuddle123</font><br>
<br><a href="/img/laoxue.png" target="_blank">优惠码具体使用方法</a><br>
<br>
<span>另,有偿提供各类服务搭建,配置加固[lamp,lnmp,vpn...],服务器代维<font color="red"> &nbsp;&nbsp;klionsec@gmail.com</span><br>
<br>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">博客累计访问共 <span id="busuanzi_value_site_pv"></span> 次</span>
<span id="busuanzi_container_site_uv">
访客数累计 <span id="busuanzi_value_site_uv"></span> 人
</span>
<span id="showDays"></span>
<script>
var birthDay = new Date("12/28/2014");
var now = new Date();
var duration = now.getTime() - birthDay.getTime(); 
var total= Math.floor(duration / (1000 * 60 * 60 * 24));
document.getElementById("showDays").innerHTML = " 其实博客已默默坚挺了 "+total+" 天";
</script>
<br>
<br>
多年实战渗透经验积累[大中小型网络] + 娴熟的底层及脚本编写能力 + 熟练的协议分析能力 + 多个大中型安全架构实际设计部署经验 + 良好的逆向分析能力[一定的0day挖掘能力] = 合格安全架构师
<br>
<br>
<font size=6 color="white">唯一不变的,就是一直在变</font>
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/klionsec">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:klionsec@gmail.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    <h2>blog by klion</h2>
                </div>
            </div>
        </div>
    </div>
		<audio autoplay="autoplay">
		<source src="/img/call you tonight.mp3" type="audio/mpeg" />
		</audio>
</footer>



<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>